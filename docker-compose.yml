---
version: "3"

services:
  postgres:
    image: postgres:9.6.9-alpine
    restart: always
    volumes:
      - postgres-db:/var/lib/postgresql/data
    networks:
      - intnet
    environment:
      POSTGRESQL_PASSWORD: passw0rd
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-U", "postgres"]
      interval: 30s
      retries: 3

  mail:
    image: mailhog/mailhog:v1.0.0
    restart: always
    networks:
      - intnet
    ports:
      - "8025:8025"

  ewallet:
    image: omisego/ewallet:stable
    restart: always
    networks:
      - intnet
    depends_on:
      - postgres
      - mail
    environment:
      DATABASE_URL: "postgresql://postgres:passw0rd@postgres:5432/ewallet"
      LOCAL_LEDGER_DATABASE_URL: "postgresql://postgres:passw0rd@postgres:5432/local_ledger"
      EWALLET_SECRET_KEY: "CHANGE_ME"
      LOCAL_LEDGER_SECRET_KEY: "CHANGE_ME"
      KEYCHAIN_SECRET_KEY: "CHANGE_ME"
    ports:
      - "4000:4000"

  geth:
    image: ethereum/client-go:v1.9.12
    entrypoint:
      - /bin/sh
      - -c
      - |
        apk add --update curl
        geth init ./geth_helper/genesis.json
        geth account import ./geth_helper/key.priv --password ./geth_helper/fake_password.txt
        geth account import ./geth_helper/key2.priv --password ./geth_helper/fake_password.txt
        geth \
          --unlock "0,1" --password ./geth_helper/fake_password.txt \
          --etherbase "6de4b3b9c28e9c3e84c2b2d3a875c947a84de68d" \
          --miner.gasprice "10" \
          --nodiscover \
          --maxpeers 0 \
          --syncmode 'full' \
          --networkid 1337 \
          --gasprice '1' \
          --rpc --rpcapi personal,web3,eth,net --rpcaddr 0.0.0.0 --rpcvhosts=* --rpcport=8545 \
          --ws --wsaddr 0.0.0.0 --wsorigins='*' \
          --mine \
          --allow-insecure-unlock
    ports:
      - "8545:8545"
      - "8546:8546"
    volumes:
      - ./tools/local_geth_testnet:/geth_helper

networks:
  intnet:

volumes:
  postgres-db:
